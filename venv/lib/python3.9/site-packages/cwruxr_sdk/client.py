from logging import exception
from typing import Optional, Any
import requests
from cwruxr_sdk.anchor_message import AnchorMessage
from cwruxr_sdk.common import FromJson, ToJson
from cwruxr_sdk.material_message import MaterialMessage
from cwruxr_sdk.object_message import ObjectMessage
from cwruxr_sdk.room_message import RoomMessage
from cwruxr_sdk import endpoints

class Client:
    """
    Client class which exposes methods for interacting with the api.
    """

    _endpointDefault = ""
    _roomIdDefault = ""
    _anchorIdDefault = ""
    _apiKeyDefault = None

    _session = None

    def __init__(
            self,
            endpoint : str,
            roomId : str,
            anchorId : str,
            apiKey: str = None
        ):
        """
        Initialization function.

        Arguments:
        endpoint -- The Api endpoint to connect to.
        roomId -- The Room to write to and read from.
        anchorId -- The anchor in the room to write to and read from.
        """
        if endpoint != None:
            self._endpointDefault = endpoint
        if roomId != None:
            self._roomIdDefault = roomId
        if anchorId != None:
            self._anchorIdDefault = anchorId
        if apiKey != None:
            self._apiKeyDefault = apiKey
        self._session = requests.Session()

    def GetHeaders(self, include_anchor : bool = True, include_room : bool = True):
        return_value = {
            "Content-Type" : "application/json"
        }
        if include_anchor:
            return_value["AnchorId"] = self._anchorIdDefault 

        if include_room:
            return_value["RoomId"] = self._roomIdDefault

        if not self._apiKeyDefault is None:
            return_value["ApiKey"] = self._apiKeyDefault

        return return_value

    ### POST ###
    def PostAnchor(
            self,
            message : AnchorMessage,
        ) -> requests.Response:
        """
        Post an anchor message to the API.
        """
        result = self._session.post(
            self._endpointDefault + endpoints.ANCHOR_ENDPOINT,
            data = ToJson(message),
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        return result

    def PostObject(
            self,
            message : ObjectMessage,
        ) -> requests.Response:
        """
        Post an object message to the API.
        """
        result = self._session.post(
            self._endpointDefault + endpoints.OBJECT_ENDPOINT,
            data = ToJson(message),
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        return result

    def PostObjectBulk(
            self,
            message : list[ObjectMessage],
        ) -> requests.Response:
        """
        Post a list of object messages to the API.
        """

        result = self._session.post(
            self._endpointDefault + endpoints.OBJECT_BULK_ENDPOINT,
            data = ToJson(message),
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        return result

    def PostMaterial(
            self,
            message : MaterialMessage,
        ) -> requests.Response:
        """
        Post a material message to the API.
        """

        data = ToJson(message)

        result = self._session.post(
            self._endpointDefault + endpoints.MATERIAL_ENDPOINT,
            data = data,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        return result

    def PostMaterialBulk(
            self,
            message : list[MaterialMessage],
        ) -> requests.Response:
        """
        Post a list of material messages to the API.
        """

        result = self._session.post(
            self._endpointDefault + endpoints.MATERIAL_BULK_ENDPOINT,
            data = ToJson(message),
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        return result

    def PostRoom(
            self,
            message : RoomMessage
        ) -> requests.Response:
        """
        Post a room message to the API.
        """

        if message.id is None:
            message.id = self._roomIdDefault
            
        result = self._session.post(
            self._endpointDefault + endpoints.ROOM_ENDPOINT,
            data = ToJson(message),
            headers = self.GetHeaders(False, False)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        return result

    ### GET ###
    def GetAllAnchors(
            self,
        ) -> list[dict[str, Any]]:
        """
        Get all anchors for the room.
        """

        result = self._session.get(
            self._endpointDefault + endpoints.ANCHOR_ENDPOINT,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        l = []
        for data in FromJson(result.content):
            l.append(data)
        return l
    
    def GetAnchor(
            self,
            id : str,
        ) -> dict[str, Any]:
        """
        Get an anchor in the room by the ID.
        """
        
        result = self._session.get(
            self._endpointDefault + endpoints.ANCHOR_ENDPOINT + id,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        return FromJson(result.content)

    def GetAllObjects(
            self,
        ) -> list[dict[str, Any]]:
        """
        Get all objects under the anchor.
        """

        result = self._session.get(
            self._endpointDefault + endpoints.OBJECT_ENDPOINT,
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        l = []
        for data in FromJson(result.content):
            l.append(data)
        return l
    
    def GetObject(
            self,
            id : str,
        ) ->  dict[str, Any]:
        """
        Get an object under the anchor by its ID.
        """
        
        result = self._session.get(
            self._endpointDefault + endpoints.OBJECT_ENDPOINT + id,
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        data = FromJson(result.content)
        return data

    def GetAllMaterials(
            self,
        ) -> list[dict[str, Any]]:
        """
        Get all materials in the room.
        """

        result = self._session.get(
            self._endpointDefault + endpoints.MATERIAL_ENDPOINT,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        l = []
        for data in FromJson(result.content):
            l.append(data)
        return l

    def GetMaterial(
            self,
            id : str
        ) ->  dict[str, Any]:
        """
        Get a material by the id.
        """
        
        result = self._session.get(
            self._endpointDefault + endpoints.MATERIAL_ENDPOINT + id,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        data = FromJson(result.content)

        return data

    def GetAllRooms(
            self,   
        ) -> dict[str, Any]:
        """
        Get all rooms on a server.
        """

        result = self._session.get(
            self._endpointDefault + endpoints.ROOM_ENDPOINT,
            headers = self.GetHeaders(False, False)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        data = FromJson(result.content)

        return data
    
    def GetRoom(
            self,
            id : str
        ) -> dict[str, Any]:
        """
        Get the details for a room.
        """
        result = self._session.get(
            self._endpointDefault + endpoints.ROOM_ENDPOINT + id,
            headers = self.GetHeaders(False, False)
        )
        if result.status_code != 200:
            raise Exception(result.reason)
        data = FromJson(result.content)

        return data

    ### Delete ###
    def DeleteAllAnchors(
            self,
        ):
        """
        Delete all anchors in the room.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.ANCHOR_ENDPOINT,
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)

    def DeleteAnchor(
            self,
            id : str,
        ):
        """
        Delete an anchor with the given ID.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.ANCHOR_ENDPOINT + id,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)

    def DeleteAllMaterials(
            self,
        ):
        """
        Delete all materials in this room.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.MATERIAL_ENDPOINT,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)

    def DeleteMaterial(
            self,
            id : str,
        ):
        """
        Delete the material with the given ID.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.MATERIAL_ENDPOINT + id,
            headers = self.GetHeaders(False, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)

    def DeleteAllObjects(
            self,
        ):
        """
        Delete all objects under the anchor.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.OBJECT_ENDPOINT,
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)

    def DeleteObjectBulk(
            self,
            ids : list[str]
        ):
        """
        Delete all objects with the given IDs.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.OBJECT_BULK_ENDPOINT,
            data = ToJson(ids),
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)

    def DeleteObject(
            self,
            id : str,
        ):
        """
        Delete the object with the given ID.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.OBJECT_ENDPOINT + id,
            headers = self.GetHeaders(True, True)
        )
        if result.status_code != 200:
            raise Exception(result.reason)

    def DeleteRoom(
            self,
            id : str,
        ):
        """
        Delete the room with the given ID.
        """
        result = self._session.delete(
            self._endpointDefault + endpoints.ROOM_ENDPOINT + id,
            headers = self.GetHeaders(False, False)
        )
        if result.status_code != 200:
            raise Exception(result.reason)